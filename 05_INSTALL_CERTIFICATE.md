# Смена локального домена и установка сертификатов

## Шаг 1. Установка mkcert

По заданию нам необходимо установить сампоподписной ssl-сертификат и работать на порту 443, а так же изменить имя нашего домена на username.42.fr. Начнём с сампоподписного сертификата.

Для подписи нашего сертификата нам потребуется утиллита mkcert.

Логинимся по ssh под нашим обычным пользователем и выполняем следующие команды:

Обновляем список репозиториев:

```sudo apt update -y```

Устанавливаем утиллиты, которые помогут нам загрузить mkcert:

```sudo apt install wget curl libnss3-tools```

Загружаем бинарник mkcert:

```curl -s https://api.github.com/repos/FiloSottile/mkcert/releases/latest| grep browser_download_url  | grep linux-amd64 | cut -d '"' -f 4 | wget -qi -```

Переименовываем загруженный файл:

```mv mkcert-v*-linux-amd64 mkcert```

Разрешаем всем пользователям исполнение файла:

```chmod a+x mkcert```

И наконец перемещаем mkcert в рабочую директорию:

```sudo mv mkcert /usr/local/bin/```

Проверяем, что всё работает, запросив версию mkcert:

```mkcert --version```

Видим следующий вывод:

![установка сертификата](media/install_certificate/step_0.png)

## Шаг 2. Смена локального домена

Далее нам необходимо сменить алиас нашего локального домена (127.0.0.1) на нужный нам nickname.42.fr. Открываем файл /etc/hosts:

```sudo nano /etc/hosts```

И заменяем ```localhost``` на наш ник.42.fr, в моём случае это ```jleslee.42.fr```:

![установка сертификата](media/install_certificate/step_1.png)

Для проверки работы домена мы можем снова запустить наш тестовый контейнер:

```cd ~/simple_docker_nginx_html/ && docker-compose up -d```

Теперь не выходя из текущей терминальной сессии переключаемся в окно виртуальной машины с нашим запущенным локальным сервером. Логинимся там под обычным пользователем и выполняем

```sudo startx```

для запуска openbox. Включив веб-браузер, вбиваем туда адрес http://jleslee.42.fr/ заменив jleslee на свой ник. Результат должен быть следующим:

![установка сертификата](media/install_certificate/step_2.png)

Как мы видим, локальный домен у нас есть, а вот сертификат отсутствует.

## Шаг 3. Получение сертификата

Свернём нашу графическую оболочку и снова откроем териминал. Теперь нам предстоит получить наш самоподписной сертификат.

Положим сертификат и ключ в папку project/srcs/requirements/tools/ (не зря же по заданию нам дана эта папка). Для начала перейдём туда:

```cd ~/project/srcs/requirements/tools/```

Для получения сертификата мы испольузем наш mkcert. Вот так я сгенерирую сертификат для своего домен jleslee.42.fr: 

```mkcert jleslee.42.fr```

Получилось следующее:

![установка сертификата](media/install_certificate/step_3.png)

Как видим, наш сертификат действует более двух лет, и это хорошо.

Единственное, что нужно нам для полного счастья - поменять расширения файлов, чтобы сервер nginx их правильно читал. Используем mv:

```mv jleslee.42.fr-key.pem jleslee.42.fr.key```

```mv jleslee.42.fr.pem jleslee.42.fr.crt```

И мы имеем в итоге ключ с сертификатом ужных нам форматов.

## Шаг 4. Перенастройка контейнера для https

Теперь нам нужно изменить настройки nginx и тестового проекта чтобы проверить работу https.

Изменим настройки конфига nginx, который лежит по адресу ~/simple_docker_nginx_html/nginx/conf.d/nginx.conf:

```nano ~/simple_docker_nginx_html/nginx/conf.d/nginx.conf```

Стираем всё содержимое файла и копируем туда код nginx.conf из корня данного репозитория с инструкциями:

![установка сертификата](media/install_certificate/step_4.png)

Обязательно поменяем в пяти местах jleslee на свой ник. Теперь нам нужно перейти в папку тестового проекта и остановить контейнер:

```cd ~/simple_docker_nginx_html/ && docker-compose down```

Затем открываем наш docker-compose.yml:

```nano docker-compose.yml```

В раздел volumes добавляем ещё один вольюм с нашими ключами:

- ./nginx/ssl:/home/user/project/srcs/requirements/tools, где user - имя нашего пользователя.

В общем, позаботимся о том, чтобы пути к сертификатам были прописаны правильно, а так же откроем порт 443 в разделе ports:

![установка сертификата](media/install_certificate/step_5.png)

## Шаг 5. Запуск проекта на https

Теперь вновь запустим наш докер командой

```docker-compose up -d```

и перейдём в GUI сервера. Обновим страницу браузера и увидим, что браузер, увы, не доверяет нашему самоподписному сертификату:

![установка сертификата](media/install_certificate/step_6.png)

К сожалению, это максимум чего мы можем добиться. Самоподписной сертификат не является доверенным, так как сертификаты выдаются специальными центрами сертификации. Всё, что мы можем - это нажать кнопку "Дополнительно" (Advanced), затем промотать страницу ниже и нажать "Принять риск и продолжить" (Accept the risk and contine):

![установка сертификата](media/install_certificate/step_7.png)

Теперь наш браузер доверяет созданному нами сертификату и наш сайт загружается по ssl. Однако всё равно не считает соединение безопасным. Браузер нужно понять и простить, а нам как веб-разработчику этого вполне хватит для нашего проекта.

![установка сертификата](media/install_certificate/step_8.png)

На этом мы можем выключать контейнер командой

```docker-compose down```

и переходить к настройкам контейнеров уже нашего боевого проекта!
