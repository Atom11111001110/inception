# Создание контейнера Nginx

И вот мы сделали снапшот, сохранили конфигурацию в облако или на флешку и готовы приступать к развёртыванию контейнеров непосредственно проекта.

Сначала давайте познакомимся с технологиями, которые мы будем использовать в наших контейнерах.

В нашем задании дана следующая схема:

![настройка nginx](media/nginx_deploy/step_1.png)

Давайте посмотрим, какой софт нам необходим, чтобы реализовать то, что здесь нарисовано:

Технология | Назначение | Создатель
------ | ------ | ------ | 
Nginx | Проксирующий веб-сервер | Игорь Сысоев (Россия)
PHP	| Скриптовой язык для веб | Расмус Лердорф (Дания)
Php-Fpm	| Набор библиотек для FastCGI API | Андрей Нигматулин (Россия)
Wordpress | Системуа управления содержимым | Мэтью Мулленвег (США)
MariaDB | Реляционная база данных | Микаэль Видениус (Финляндия)
---
Эта таблица сразу же приобщает нас к перкрасному, ибо здесь прекрасно всё.

Лучший проксирующий веб-сервер, созданный нашим соотечественником Игорем Сысоевым, занимающий 30% рынка серверов. Именно на этой прекрасно задокументированной софтине держится 30% интернета и львиная доля больших и высоконагруженных сайтов, ибо именно под высокие нагрузки этот сервер и писался c 2002 года.

Именно его мы будем настраивать в этом гайде, а пока познакомимся с остальными нужными нам технологиями.

Язык PHP создан датчанином Лердорфом для личных целей в 1995 году, однако он быстро завоевал популярность в веб-разработке и до сих пор является одним из лидирующих языков для веба.

Библиотека php-fpm от нашего соотечественника Андрея Нигматулина стала стандартным API между php и веб-серверами, в том числе Nginx-ом. Именно она подружит наш nginx с php. Устанавливается в контейнер с php.

Wordpress - замечательная и лёгкая в настройке CMS - система, изучив которую можно начинать принимать заказы на сайты на фрилансе :). Создана в 2003 году.

MariaDB - легковесный аналог базы данных MySQL. И то и другое - творение финна Видениуса, назвавшего MySQL в честь своей старшей дочери Мю, а MariaDB - в честь младшей, Марии.

Все эти технологии относительно просты, лакончины и функциональны, что делает их прекрасным выбором и для начинающих веб-программистов, и для профессионалов.

И всё это работает под управлением ОС Linux - прекрасного творения финна Линуса Торвальдса, на котором зиждется весь современный интернет, и крутится внутри контейнеров Docker, системы контейнеризации, созданной американцем Соломоном Хайксом. Ядро Линукс появилось в 1992-93, а Docker в 2013-м.

![настройка nginx](media/nginx_deploy/step_0.png)

Вот так два американца, двое русских и два финна создали все необходимые нам для задания технологии. И как-то случано между ними затесался живущий в Каннаде датчанин, создатель одной из базовых технологий - самого языка, который используется нами для wordpress.

Итак, приступим к настройке сервера с Nginx.

## Шаг 1. Введение в Docker

Докер образ - это набор окружения, необходимого для запуска определённого софта. От систем эмуляции по типу virtualbox он отличается тем, что в контенере не содержится полноценной операционной системы, контейнер использует ядро Linux и внутрь него помещаются не все, а только необходимые для запуска софта программы и библиотеки.

Таким образом контейнер весит значительно меньше, чем эмулируемая система. Убедимся в этом наглядно. Посмотрим, сколько весит наша ОС в установленном виде:

![настройка nginx](media/nginx_deploy/step_2.png)

И сравним это с тем же образом одиннадцатого debian на [Docker Hub](https://hub.docker.com/ "docker hub") - официальном хранилище образов Docker:

![настройка nginx](media/nginx_deploy/step_3.png)

Образ весит всего 50 МБ в сжатом виде (сжатый диск с Debian у нас весил 950 МБ!). После распаковки этот образ будет весить около 150 МБ. Вот такая значительная разница. И это далеко не предел.

Всё потому, что для запуска отдельного софта не нужна вся полноценная операционная система, достаточно рабочего ядра и некоторого окружения из всех зависимостей - модулей, библиотек, пакетов и скриптов. По такому принципу работает wine, само название которого гласит что Wine - Is Not Emulator. Он помогает запускать виндовые приложения в среде линукс, устанавливая только нужные зависимости и ничего лишнего.

Итак, когда мы разобрались в отличии эмуляторов и контейнеров, переходим к изучению того, как работает Docker.

## Шаг 2. Поиск нужного образа на DockerHub

В Докере за конфигурацию отвечает специальный файл, который называется Dockerfile. В нём прописывается набор софта, который мы хотим развернуть внутри данного контейнера.

Начнём создавать наш контейнер для веб-сервера Nginx. Я буду подробно описывать те шаги, которые произведу я для настройки nginx-а.

Сначала я перейду на тот самый [Docker Hub](https://hub.docker.com/ "docker hub") и вверху в поиске введу слово ```nginx```. Потом перейду на официальный репозиторий nginx-а (первый в списке с зелёным значком), нажму вкладку "Tags" и забью в поиск тег ```alpine```:

![настройка nginx](media/nginx_deploy/step_4.png)

Alpine - самая легковесная система, используемая в Docker и микроконтроллерах, контейнеры с ней будут весить значительно меньше контейнеров с debian или ubuntu. Поэтому везде, где это возможно, нужно стараться использовать эту систему. И дело тут даже не в экономии места, а в скорости отклика - чем меньше в системе составляющих, тем быстрее она рабоатет, и тем меньше бывает сбоев (хотя на самом деле все официальные образы docker как правило - штуки очень надёжные).

Находим в поиске стабильную версию alpine с названием ```stable-alpine``` и копируем её тег из docker pull, нам нужно только название образа: ```nginx:stable-alpine```:

![настройка nginx](media/nginx_deploy/step_5.png)

Если стабильные версии образов удовлетворяют нашим требованиям, всегда нужно использовать именно стабильные версии.

## Шаг 3. Создание Dockerfile

Переходим в папку нашего nginx:

```cd ~/project/srcs/requirements/nginx/```

Создаём в ней Dockerfile:

```nano Dockerfile```

И прописываем в нём инструкцию FROM, которая указывает из какого образа мы будем разворачивать наш контейнер:

```FROM nginx:stable-alpine```

Подробнее о инструкциях можно посмотреть в [этом видео](https://www.youtube.com/watch?v=wskg5903K8I "docker от Антона Павленко"), здесь же разберём лишь некоторые из них.

Далее мы прописываем, какой софт и как мы хотим установить внутрь контейнера. В этом нам поможет инструкция RUN.

Инструкция ```RUN``` создаёт новый слой образа с результатом вызванной команды, подобно тому, как система снапшотов сохраняет изменения в виртуальной машине. Собственно, сам образ и состаит из таких вот слоёв-изменений.

Ещё одной особенностью ```RUN``` является то, что сделанные изменения статичны. То есть, ```RUN``` подходит чтобы положить в окружение файлы или установить пакеты, но вот запустить из них приложение не получится, для этого есть другие инструкции. Какие - узнаем дальше.

А пока пропишем (или скопипастим) это:

```RUN	apk update && apk upgrade && apk add --no-cache nginx```

Здесь мы говорим файловому менеджеру apk чтобы он обновил список своих репозиториев в поисках пследних версий софа (apk update), обновил устаревшие пакеты в нашем окружении (apk upgrade) и установил nginx не сохраняя исходники в кэше (apk add --no-cache nginx). Работает почти так же, как ```apt``` в debian.

В конце концов мы должны запустить установленную конфигурацию. Для этого используем инструкцию ```CMD```:

```CMD ["nginx", "-g", "daemon off;"]```

Таким образом мы запускаем nginx в режиме демона, или, выражаясь языком windows, как службу.

Вот, собственно, и весь Dockerfile. Просто, не правда ли?

```
FROM nginx:stable-alpine
RUN	apk update && apk upgrade && apk add --no-cache nginx
CMD ["nginx", "-g", "daemon off;"]
```